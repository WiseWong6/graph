# Article Agent Workflow Graph

## åŒé‡å¹¶è¡Œä¼˜åŒ–ç‰ˆæµç¨‹å›¾

```mermaid
graph TD
    START([å¼€å§‹]) --> A[00_select_wechat<br/>é€‰æ‹©å…¬ä¼—å· âœ…]
    A --> B[01_select_model<br/>é€‰æ‹©æ¨¡å‹ âœ…]
    B --> C[02_research<br/>è°ƒç ” âœ…]

    %% ç¬¬ä¸€å±‚å¹¶è¡Œï¼šResearch å
    C --> D[03_rag<br/>RAGæ£€ç´¢ âœ…]
    C --> E[04_titles<br/>ç”Ÿæˆæ ‡é¢˜ âœ…]
    D --> F[05_select_title<br/>é€‰æ‹©æ ‡é¢˜ âœ…]
    E --> F

    F --> G[06_draft<br/>ç”Ÿæˆåˆç¨¿ âœ…]
    G --> H[07_rewrite<br/>æ™ºæ€§å™äº‹é‡å†™ âœ…]
    H --> I[08_confirm<br/>ç¡®è®¤å›¾ç‰‡é…ç½® âœ…]

    %% ç¬¬äºŒå±‚å¹¶è¡Œï¼šConfirm å
    I --> J[09_humanize<br/>Code First, AI Second âœ…]
    I --> K[10_prompts<br/>ç”Ÿæˆå›¾ç‰‡æç¤ºè¯ âœ…]
    K --> L[11_images<br/>ç”Ÿæˆå›¾ç‰‡ âœ…]
    L --> M[12_upload<br/>ä¸Šä¼ åˆ°CDN âœ…]
    M --> N[13_wait_for_upload<br/>å¹¶è¡ŒåŒæ­¥ç‚¹ âœ…]

    %% æ±‡èšç‚¹
    J --> O[14_html<br/>Markdownè½¬HTML âœ…]
    N --> O
    O --> P[15_draftbox<br/>å‘å¸ƒåˆ°è‰ç¨¿ç®± âœ…]
    P --> END([ç»“æŸ])

    style A fill:#d4edda
    style B fill:#d4edda
    style C fill:#d4edda
    style D fill:#d4edda
    style E fill:#d4edda
    style F fill:#d4edda
    style G fill:#d4edda
    style H fill:#d4edda
    style I fill:#d4edda
    style J fill:#d4edda
    style K fill:#d4edda
    style L fill:#d4edda
    style M fill:#d4edda
    style N fill:#d4edda
    style O fill:#d4edda
    style P fill:#d4edda
```

**éªŒè¯çŠ¶æ€å›¾ä¾‹**:
- âœ… å·²éªŒè¯é€šè¿‡

## éªŒè¯è¿›åº¦è¡¨

| èŠ‚ç‚¹ | èŠ‚ç‚¹ä½œç”¨ | ç±»å‹ | çŠ¶æ€ |
|------|----------|------|------|
| 00_select_wechat | é€‰æ‹©å…¬ä¼—å·è´¦å· | äº¤äº’ | âœ… éªŒè¯é€šè¿‡ |
| 01_select_model | é€‰æ‹© LLM æ¨¡å‹ | äº¤äº’ | âœ… éªŒè¯é€šè¿‡ |
| 02_research | æœç´¢ + Brief ç”Ÿæˆ | LLM | âœ… éªŒè¯é€šè¿‡ |
| 03_rag | RAG å‘é‡æ£€ç´¢ | LLM | âœ… éªŒè¯é€šè¿‡ |
| 04_titles | ç”Ÿæˆ 5-10 ä¸ªå€™é€‰æ ‡é¢˜ | LLM | âœ… éªŒè¯é€šè¿‡ |
| 05_select_title | ä»å€™é€‰æ ‡é¢˜ä¸­é€‰æ‹©/è‡ªå®šä¹‰/é‡æ–°ç”Ÿæˆ | äº¤äº’ | âœ… éªŒè¯é€šè¿‡ |
| 06_draft | Research + RAG â†’ åˆç¨¿ | LLM | âœ… éªŒè¯é€šè¿‡ |
| 07_rewrite | æ™ºæ€§å™äº‹é‡å†™ (IPS+HKR) | LLM | âœ… éªŒè¯é€šè¿‡ |
| 08_confirm | ç¡®è®¤å›¾ç‰‡æ•°é‡å’Œé£æ ¼ | äº¤äº’ | âœ… éªŒè¯é€šè¿‡ |
| 09_humanize | Code æ¸…æ´— + LLM é£æ ¼ä¼˜åŒ– | LLM + Code | âœ… éªŒè¯é€šè¿‡ |
| 10_prompts | ç”Ÿæˆå›¾ç‰‡æç¤ºè¯ (5ç§é£æ ¼) | LLM | âœ… éªŒè¯é€šè¿‡ |
| 11_images | Ark API ç”Ÿæˆå›¾ç‰‡ï¼ˆå¹¶è¡Œï¼‰ | API | âœ… éªŒè¯é€šè¿‡ |
| 12_upload | ä¸Šä¼ åˆ°å¾®ä¿¡ CDNï¼ˆå¹¶è¡Œ+å›é€€ï¼‰ | API | âœ… éªŒè¯é€šè¿‡ |
| 13_wait_for_upload | å¹¶è¡ŒåŒæ­¥ç‚¹ | åŒæ­¥ | âœ… éªŒè¯é€šè¿‡ |
| 14_html | Markdown â†’ HTMLï¼ˆæ›¿æ¢å›¾ç‰‡ï¼‰ | Code | âœ… éªŒè¯é€šè¿‡ |
| 15_draftbox | å‘å¸ƒåˆ°å¾®ä¿¡è‰ç¨¿ç®±ï¼ˆstable tokenï¼‰ | API | âœ… éªŒè¯é€šè¿‡ |

**å½“å‰è¿›åº¦**: 16/16 èŠ‚ç‚¹å·²éªŒè¯ (100%)

## æ•°æ®æµè¯¦è§£

### é˜¶æ®µ 1: é¡ºåºå‰ç½®æµç¨‹
```
START â†’ 00 â†’ 01 â†’ 02
```
- é€‰æ‹©å…¬ä¼—å·
- é€‰æ‹©æ¨¡å‹
- æ‰§è¡Œè°ƒç ”

### é˜¶æ®µ 2: ç¬¬ä¸€å±‚å¹¶è¡Œ (Research å)
```
        â”Œâ”€â†’ 03_rag â”€â”€â”€â”€â”€â”
02 â”€â”€â”€â”€â”€â”¤               â”œâ”€â†’ 05_select_title
        â””â”€â†’ 04_titles â”€â”€â”˜
```

**å…³é”®è®¾è®¡**:
1. `03_rag` å’Œ `04_titles` åŒæ—¶ä» `02_research` å¼€å§‹
2. ä¸¤è€…éƒ½å®Œæˆåï¼Œ`05_select_title` æ‰èƒ½æ‰§è¡Œï¼ˆjoin è¾¹ï¼‰
3. **æ—¶é—´èŠ‚çœ**: max(T03, T04) vs T03 + T04

### é˜¶æ®µ 3: é¡ºåºä¸­é—´æµç¨‹
```
05 â†’ 06 â†’ 07 â†’ 08
```
- é€‰æ‹©æ ‡é¢˜ â†’ ç”Ÿæˆåˆç¨¿ â†’ æ™ºæ€§å™äº‹é‡å†™ â†’ ç¡®è®¤å›¾ç‰‡é…ç½®

### é˜¶æ®µ 4: ç¬¬äºŒå±‚å¹¶è¡Œ (Confirm å)
```
              â”Œâ”€â†’ 10_prompts â†’ 11_images â†’ 12_upload â†’ 13_wait
08_confirm â”€â”€â”€â”¤
              â””â”€â†’ 09_humanize
```

**å…³é”®è®¾è®¡**:
1. `09_humanize` å’Œ `10_prompts` åŒæ—¶ä» `08_confirm` å¼€å§‹
2. `10_prompts` ä½¿ç”¨ `draft` ä½œä¸ºè¾“å…¥ï¼ˆä¸æ˜¯ `humanized`ï¼‰
3. `13_wait_for_upload` ç¡®ä¿ä¸Šä¼ å®Œæˆåæ‰è§¦å‘ HTML è½¬æ¢

### é˜¶æ®µ 5: æ±‡èšç‚¹
```
    â”Œâ”€ 09_humanize â”€â”€â”
â”€â”€â”€â”¤                 â”œâ”€â†’ 14_html â†’ 15_draftbox â†’ END
    â””â”€ 13_wait â”€â”€â”€â”€â”€â”˜
```

**æ±‡èšæ¡ä»¶**:
- `09_humanize` å’Œ `13_wait_for_upload` éƒ½å®Œæˆå
- `14_html` æ‰å¼€å§‹æ‰§è¡Œï¼ˆjoin è¾¹ï¼‰
- å°†å›¾ç‰‡å ä½ç¬¦æ›¿æ¢ä¸º CDN URL

## æ€§èƒ½ä¼˜åŒ–åˆ†æ

### åŸä¸²è¡Œæµç¨‹
```
00 â†’ 01 â†’ 02 â†’ 03 â†’ 04 â†’ 05 â†’ 06 â†’ 07 â†’ 08 â†’ 09 â†’ 10 â†’ 11 â†’ 12 â†’ 13 â†’ 14 â†’ 15
```

### æ–°å¹¶è¡Œæµç¨‹ï¼ˆåŒé‡ä¼˜åŒ–ï¼‰
```
        â”Œâ”€ 03 â”€â”€â”€â”€â”€â”
02 â”€â”€â”€â”€â”€â”¤          â”œâ”€â†’ 05 â†’ 06 â†’ 07 â†’ 08 â”€â”¬â”€â†’ 09 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â””â”€ 04 â”€â”€â”€â”€â”€â”˜                    â””â”€â†’ 10 â†’ 11 â†’ 12 â†’ 13 â”˜
                                                    â”‚
                                                    â””â”€â”€â†’ 14 â”€â†’ 15
```

**ç¬¬ä¸€å±‚æ—¶é—´èŠ‚çœ** (Research å):
- åŸ: T03 + T04
- æ–°: max(T03, T04)
- èŠ‚çœ: min(T03, T04)

**ç¬¬äºŒå±‚æ—¶é—´èŠ‚çœ** (Confirm å):
- åŸ: T09 + T10 + T11 + T12 + T13
- æ–°: max(T09, T10 + T11 + T12 + T13)
- èŠ‚çœ: min(T09, T10 + T11 + T12 + T13)

**æ€»æ—¶é—´èŠ‚çœ**:
```
åŸ: T00 + T01 + T02 + T03 + ... + T15
æ–°: T00 + T01 + T02 + max(T03, T04) + ... + max(T09, T10+T11+T12+T13) + T14 + T15
```

å‡è®¾ T03=30s, T04=20s, T09=15s, T10+T11+T12+T13=30s:
- ç¬¬ä¸€å±‚èŠ‚çœ: 20s
- ç¬¬äºŒå±‚èŠ‚çœ: 15s
- **æ€»èŠ‚çœ: 35s**

## çŠ¶æ€ä¾èµ–å…³ç³»

| èŠ‚ç‚¹ | è¯»å–çŠ¶æ€ | å†™å…¥çŠ¶æ€ |
|------|---------|---------|
| 08_confirm | - | `decisions.images.count` |
| 09_humanize | `decisions.images.count` | `humanized` + å ä½ç¬¦ |
| 10_prompts | `draft` + `decisions.images` | `imagePrompts` |
| 11_images | `imagePrompts` | `imagePaths` |
| 12_upload | `imagePaths` + `decisions.wechat` | `uploadedImageUrls` |
| 13_wait_for_upload | `uploadedImageUrls` | - |
| 14_html | `humanized` + `uploadedImageUrls` | `html` |

## è¾¹ç•Œæƒ…å†µå¤„ç†

### å¦‚æœ confirm è¢«è·³è¿‡
- `09_humanize` ä½¿ç”¨é»˜è®¤å€¼ `imageCount = 0`
- `10_prompts` ä½¿ç”¨é»˜è®¤å€¼ `count = 4, style = infographic`

### å¦‚æœå›¾ç‰‡ç”Ÿæˆå¤±è´¥
- `12_upload` è¿”å›ç©ºæ•°ç»„
- `14_html` ä¼šæŠ¥é”™å¹¶ä¸­æ­¢ï¼Œéœ€è¦é‡è¯•ä¸Šä¼ æˆ–å°†å›¾ç‰‡æ•°è®¾ä¸º 0

### å¦‚æœ humanize å¤±è´¥
- é™çº§åˆ° `rewritten`
- `14_html` ç»§ç»­æ‰§è¡Œ

### å¦‚æœæ¢å¤ä¼šè¯æ—¶ wechat é…ç½®ç¼ºå¤±
- `12_upload` è§¦å‘å›é€€æœºåˆ¶ï¼Œè‡ªåŠ¨æç¤ºç”¨æˆ·é€‰æ‹©å…¬ä¼—å·
- é€‰æ‹©çš„é…ç½®è‡ªåŠ¨ä¿å­˜åˆ° stateï¼Œä¸‹æ¬¡æ¢å¤ä¸ä¼šä¸¢å¤±
- ç”¨æˆ·æ— éœ€é‡æ–°è¿è¡Œæ•´ä¸ªæµç¨‹

## Humanize èŠ‚ç‚¹æ•°æ®æµ

```
rewritten (è¾“å…¥)
    â†“
[LLM] å»é™¤ AI å‘³ï¼Œå¢åŠ æ´»äººæ„Ÿ
    â†“
humanized (LLM è¾“å‡º)
    â†“
[Code] cleanTextFormatting
    â”œâ”€ ç ´æŠ˜å·æ›¿æ¢
    â”œâ”€ æ ‡ç‚¹ä¸­æ–‡åŒ–
    â”œâ”€ å»å¤šä½™ç©ºæ ¼
    â”œâ”€ å»å¼•å·
    â””â”€ å»ç©ºè¡Œ
    â†“
[Code] restoreBoldMarkers (æ¢å¤åŠ ç²—)
    â†“
[Code] ensureImagePlaceholders (æ’å…¥å›¾ç‰‡å ä½ç¬¦)
    â†“
humanized (æœ€ç»ˆè¾“å‡º)
```

## Upload èŠ‚ç‚¹å›é€€æµç¨‹

```
state.decisions.wechat å­˜åœ¨ï¼Ÿ
    â†“ æ˜¯
æ­£å¸¸ä¸Šä¼ 
    â†“ å¦
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ promptForWechat() â”‚ â† äº¤äº’å¼é€‰æ‹©å…¬ä¼—å·
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
ä¿å­˜åˆ° state.decisions.wechat
    â†“
ç»§ç»­ä¸Šä¼ 
```

## å¹¶è¡Œæ‰§è¡Œæ£€æµ‹æœºåˆ¶

### Step CLI å¹¶è¡Œè¿½è¸ª

```typescript
// æ£€æµ‹å¹¶è¡Œæ‰§è¡Œ
if (eventType === "on_chain_start") {
    tracker.activeNodes.set(nodeName, Date.now());
    if (tracker.activeNodes.size > 1) {
        console.log(`âš¡ å¹¶è¡Œæ‰§è¡Œ [${tracker.activeNodes.size}]`);
    }
}
```

### æµå¼è¾“å‡ºç¼“å†²

**èšç„¦èŠ‚ç‚¹æœºåˆ¶ï¼š**
- Research åå¹¶è¡Œï¼šèšç„¦ `04_titles`ï¼Œç¼“å†² `02_rag`
- Confirm åå¹¶è¡Œï¼šèšç„¦ `09_humanize`ï¼Œç¼“å†² `10_prompts/11_images/12_upload`

```typescript
const getStreamFocusNode = (currentNode: string): string | null => {
  if (currentNode === "04_titles" || currentNode === "03_rag") {
    return "04_titles";
  }
  if (currentNode === "09_humanize" ||
      currentNode === "10_prompts" ||
      currentNode === "11_images" ||
      currentNode === "12_upload" ||
      currentNode === "13_wait_for_upload") {
    return "09_humanize";
  }
  return null;
};
```

## èŠ‚ç‚¹é”™è¯¯å¤„ç†

### é”™è¯¯æ¢å¤é€‰é¡¹

å½“èŠ‚ç‚¹æ‰§è¡Œå¤±è´¥æ—¶ï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©ï¼š

1. **é‡è¯• (r)**: é‡æ–°æ‰§è¡Œå½“å‰èŠ‚ç‚¹
2. **è·³è¿‡ (s)**: è·³è¿‡å½“å‰èŠ‚ç‚¹ï¼Œç»§ç»­æ‰§è¡Œ
3. **é‡æ–°è¿è¡Œ (n)**: ä»ä»»æ„èŠ‚ç‚¹é‡æ–°è¿è¡Œ
4. **é€€å‡º (q)**: é€€å‡ºæµç¨‹ï¼Œä¿å­˜å½“å‰çŠ¶æ€

### é”™è¯¯å¤„ç†æµç¨‹

```typescript
async function handleNodeError(error, threadId, ...) {
  console.error("é”™è¯¯:", error);

  const answer = await inquirer.prompt([
    {
      type: "list",
      name: "action",
      message: "é€‰æ‹©æ“ä½œ [r=é‡è¯•, s=è·³è¿‡, n=ä»æŸèŠ‚ç‚¹é‡æ–°è¿è¡Œ, q=é€€å‡º]: "
    }
  ]);

  switch (answer.action) {
    case "r": await retry(); break;
    case "s": await skip(); break;
    case "n": await rerunFromNode(); break;
    case "q": await exit(); break;
  }
}
```

## æ€§èƒ½æŒ‡æ ‡

### MetricsTracker è¿½è¸ª

**èŠ‚ç‚¹æ‰§è¡Œç»Ÿè®¡ï¼š**
- æ‰§è¡Œæ—¶é—´
- æˆåŠŸ/å¤±è´¥çŠ¶æ€
- LLM Token ä½¿ç”¨é‡

**ç³»ç»Ÿèµ„æºï¼š**
- å†…å­˜ä½¿ç”¨ï¼ˆheap/heap total/rssï¼‰
- èŠ‚ç‚¹é”™è¯¯ç»Ÿè®¡

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```typescript
const startTime = metrics.startNodeExecution("09_humanize");
try {
  const result = await callLLM(...);
  metrics.endNodeExecution("09_humanize", startTime, true, undefined, {
    promptTokens: result.promptTokens,
    completionTokens: result.completionTokens,
    totalTokens: result.totalTokens
  });
} catch (error) {
  metrics.endNodeExecution("09_humanize", startTime, false, String(error));
}
```

## ResumeManager åŠŸèƒ½

### Thread åˆ—è¡¨æ˜¾ç¤º

```
â­ [æ¨è] âœ… ä»Šæ™š 20ç‚¹30åˆ† - å†™ä¸€ç¯‡å…³äº AI Agent çš„æ–‡ç« 
   èŠ‚ç‚¹: è‰ç¨¿ç®± | å·²è€—æ—¶: 5m 30s
  âœ… æ˜¨å¤© 14ç‚¹20åˆ† - å¦ä¸€ä¸ªä¸»é¢˜
   èŠ‚ç‚¹: å®Œæˆ | å·²è€—æ—¶: 4m 15s
  â¸ï¸ å‰å¤© 10ç‚¹10åˆ† - ä¸­æ–­çš„ä¸»é¢˜
   èŠ‚ç‚¹: ç”Ÿæˆå›¾ç‰‡ | å·²è€—æ—¶: 2m 40s
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ†• æ–°å»ºä¼šè¯
```

### Checkpoint åˆ—è¡¨æ˜¾ç¤º

```
â­ [æ¨è] 20ç‚¹30åˆ† - ç”Ÿæˆå›¾ç‰‡æç¤ºè¯
   å€™é€‰æ•°: 5 ä¸ª
   â†“ ä¸‹ä¸€æ­¥: ç”Ÿæˆå›¾ç‰‡
  20ç‚¹25åˆ† - ç¡®è®¤å›¾ç‰‡é…ç½®
  20ç‚¹15åˆ† - æ™ºæ€§å™äº‹é‡å†™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”™ è¿”å›
```

## å®Œæ•´ä½¿ç”¨ç¤ºä¾‹

### æ–°å»ºæ–‡ç« 

```bash
npm run step
```

**æµç¨‹ï¼š**
1. é€‰æ‹©å…¬ä¼—å·
2. é€‰æ‹©æ¨¡å‹
3. è¾“å…¥ä¸»é¢˜
4. ç­‰å¾…è°ƒç ” + RAG + æ ‡é¢˜ç”Ÿæˆï¼ˆå¹¶è¡Œï¼‰
5. é€‰æ‹©æ ‡é¢˜
6. ç­‰å¾…åˆç¨¿ + é‡å†™
7. ç¡®è®¤å›¾ç‰‡é…ç½®
8. ç­‰å¾…äººåŒ– + å›¾ç‰‡ç”Ÿæˆ + ä¸Šä¼ ï¼ˆå¹¶è¡Œï¼‰
9. HTML è½¬æ¢ + å‘å¸ƒåˆ°è‰ç¨¿ç®±

### æ¢å¤ä¸­æ–­çš„ä¼šè¯

```bash
npm run step -- --resume
```

**æµç¨‹ï¼š**
1. é€‰æ‹©è¦æ¢å¤çš„ä¼šè¯
2. é€‰æ‹©æ¢å¤ç‚¹ï¼ˆcheckpointï¼‰
3. ä»ä¸­æ–­å¤„ç»§ç»­æ‰§è¡Œ

### ä»ç‰¹å®šèŠ‚ç‚¹é‡æ–°è¿è¡Œ

```bash
npm run step -- --resume
# åœ¨é”™è¯¯å¤„ç†èœå•é€‰æ‹© 'n' (ä»æŸèŠ‚ç‚¹é‡æ–°è¿è¡Œ)
# é€‰æ‹©è¦é‡æ–°è¿è¡Œçš„èŠ‚ç‚¹
```

## ä¸‹ä¸€æ­¥ä¼˜åŒ–

### å·²å®Œæˆ âœ…
- åŒé‡å¹¶è¡Œä¼˜åŒ–
- Humanize é‡æ„ï¼ˆCode First, AI Secondï¼‰
- Upload å›é€€æœºåˆ¶
- ResumeManager å¢å¼º
- Step CLI æµå¼è¾“å‡ºç¼“å†²
- MetricsTracker å®Œæ•´å®ç°

### è®¡åˆ’ä¸­ ğŸ“‹
- å·¥ä½œæµç«¯åˆ°ç«¯æµ‹è¯•
- åŸºäºå®é™…ä½¿ç”¨çš„ Prompt ä¼˜åŒ–
- é”™è¯¯å¤„ç†å¢å¼º
- æ›´å¤šé£æ ¼çš„å›¾ç‰‡æç¤ºè¯æ¨¡æ¿
- æ€§èƒ½ç›‘æ§é¢æ¿
- å¯¼å‡ºæ ¼å¼æ‰©å±•ï¼ˆPDFã€DOCXï¼‰
